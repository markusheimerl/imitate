name: Train and Release

on:
  workflow_dispatch:
    inputs:
      generations:
        description: 'Number of generations'
        required: true
        default: '10'
        type: string

jobs:
  train-and-visualize:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup and Train
      run: |
        sudo apt-get update && sudo apt-get install -y clang make
        make all
        ./orchestrate.out ${{ github.event.inputs.generations }}
        WEIGHTS_FILE=$(ls -t *_policy.bin | head -n1)
        ./visualize.out $WEIGHTS_FILE
        GIF_FILE=$(ls -t *_flight.gif | head -n1)
        
        echo "WEIGHTS_FILE=${WEIGHTS_FILE}" >> $GITHUB_ENV
        echo "GIF_FILE=${GIF_FILE}" >> $GITHUB_ENV
        echo "TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: run-${{ github.run_number }}
        name: "🚁 Quadcopter Training #${{ github.run_number }}"
        body: |
          ## ✨ Training Details
          
          - 🔄 Generations: ${{ github.event.inputs.generations }}
          - ⏰ Completed: ${{ env.TIMESTAMP }}
          
          ## 🎥 Flight Visualization
          ![Flight Visualization](${{ env.GIF_FILE }})
          
          ## 📦 Downloads
          - 🧠 [Policy Weights](${{ env.WEIGHTS_FILE }})
          - 🎬 [Flight Animation](${{ env.GIF_FILE }})
          
          ---
          *🤖 Generated by Autonomous Control Training Pipeline*
        files: |
          ${{ env.WEIGHTS_FILE }}
          ${{ env.GIF_FILE }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}